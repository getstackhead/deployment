resource "nginx_server_block" "nginx-{{ project_name }}" {
  filename = "{{ project_name }}.conf"
  enable = true

  depends_on = [
    {%- for domainConfig in app_config.domains if (domainConfig.security is defined and domainConfig.security.authentication is defined) %}
    {%- if not loop.first %},{% endif %}local_file.auth-{{ project_name }}-{{ domainConfig.domain|replace('.', '_') }}
    {%- endfor %}
  ]

  content = <<EOF
{% for domain in app_config.domains %}
{{ lookup('template', "{{ stackhead__templates }}/nginx/serverblock.http.j2", template_vars=dict(domainConfig=domain)) }}
{{ lookup('template', "{{ stackhead__templates }}/nginx/serverblock.native-https.j2", template_vars=dict(domainConfig=domain)) }}
{% endfor %}
EOF

  provisioner "local-exec" {
    # Symlink project certificate files to snakeoil files after initial creation
    command = <<EOT
            ln -s {{ stackhead__snakeoil_fullchain }} {{ stackhead__certificates_project_folder }}/fullchain.pem || true &&
            ln -s {{ stackhead__snakeoil_privkey }} {{ stackhead__certificates_project_folder }}/privkey.pem || true &&
            sudo systemctl reload nginx
EOT
  }
  provisioner "local-exec" {
    when = destroy
    command = "sudo systemctl reload nginx"
  }
}