---
- block:
  - name: "StackHead::Docker || Check if project directory exists | Project: {{ dockerapp__project_name }}"
    stat:
      path: "{{ dockerapp__project_src }}"
    register: project_folder
  - name: "StackHead::Docker || Create project directory if not exists | Project: {{ dockerapp__project_name }}"
    file:
      path: "{{ dockerapp__project_src }}"
      state: directory
    when: project_folder.stat.exists == false

- block:
  - name: "StackHead::Docker || Tear down existing services | Project: {{ dockerapp__project_name }}"
    docker_compose:
      project_src: "{{ dockerapp__project_src }}"
      state: absent
    ignore_errors: yes
    vars:
      ansible_python_interpreter: "/usr/bin/env python-docker"

  - name: "StackHead::Docker || Generate docker-compose file | Project: {{ dockerapp__project_name }}"
    block:
      - template:
          src: "templates/docker-compose.base.yml.j2"
          dest: "{{ dockerapp__project_src }}/docker-compose.base.yml"
          force: true
        tags:
          - template
      - template:
          src: "templates/docker-compose.volumes.yml.j2"
          dest: "{{ dockerapp__project_src }}/docker-compose.volumes.yml"
          force: true
        tags:
          - template

  - name: "StackHead::Docker || Create and start services | Project: {{ dockerapp__project_name }}"
    docker_compose:
      project_src: "{{ dockerapp__project_src }}"
      files:
        - docker-compose.base.yml
        - docker-compose.volumes.yml
    vars:
      ansible_python_interpreter: "/usr/bin/env python-docker"
  when: dockerapp__file_changed == true

# Always fetch port - required for Nginx config update when domain changed
- block:
  - name: "StackHead::Docker || Get current Docker port"
    shell: "docker port stackhead-{{ project_name }}-{{ item.key }} {{ dockerapp__expose.port }}"
    when: dockerapp__expose is defined and item.key == dockerapp__expose.service
    with_dict: "{{ dockerapp__services }}"
    register: used_port

  - set_fact:
      docker_port: "{{ item.stdout | replace('0.0.0.0:','') }}"
    when: item.changed == true
    with_items: "{{ used_port.results }}"